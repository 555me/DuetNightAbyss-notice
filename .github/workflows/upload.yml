name: Generate Notice Markdown

on:
  workflow_dispatch:
  schedule:
    - cron: 52 * * * *

jobs:
  generate-markdown:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests py-lua-parser
    
    - name: Fetch and process notices
      run: |
        python << 'EOF'
        import requests
        import re
        import os
        from lua_parser import parse
    
        url = "https://pan01-cdn-dna-ali.shyxhy.com/OperationGameNotice/OperationGameNotice10001"
        response = requests.get(url)
        lua_content = response.text
    
        lua_data = parse(lua_content)
    
        for unique_id, notice_data in lua_data.items():
          filename = f"{unique_id}.md"
          title = notice_data.get("Title", "")
          end_timestamp = notice_data.get("EndTimestamp", 0)
          content = notice_data.get("Content", {})
        
          md_content = f"# {title}\\n\\n"
        
          if content:
            first_item = list(content.values())[0] if isinstance(content, dict) else content[0]
            
            if "noticeImage" in first_item:
              notice_image = first_item["noticeImage"]
              notice_image_url = first_item.get("noticeImageURL", "")
                
              image_desc_match = re.search(r'upload/([^.]*)', notice_image)
              image_desc = image_desc_match.group(1) if image_desc_match else "公告图片"
                
              md_content += f"[![{image_desc}]({notice_image})]({notice_image_url})"
            
            elif "body" in first_item:
              body_content = first_item["body"]
              body_content = body_content.replace("\\n", "<br/>").replace("\\", "")
              md_content += body_content
        
          with open(filename, 'w', encoding='utf-8') as f:
            f.write(md_content)
    
        readme_content = "# 公告列表\\n\\n| UniqueId | Title | EndTimestamp |\\n|----------|-------|-------------|\\n"
    
        for unique_id, notice_data in lua_data.items():
          title = notice_data.get("Title", "")
          end_timestamp = notice_data.get("EndTimestamp", 0)
          readme_content += f"| {unique_id} | {title} | {end_timestamp} |\\n"
    
        with open("readme.md", 'w', encoding='utf-8') as f:
          f.write(readme_content)
    
        print("处理完成！")
        EOF
        
    - name: Commit generated files
      id: commit-files
      run: |
        # 检查是否有新文件生成
        if git diff --name-only --exit-code; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          git config --local user.email "666you@github.com"
          git config --local user.name "666you"
          git add *.md
          git commit -m "Auto-generate notice markdown files [skip ci]"
        fi
        
    - name: Push changes
      if: steps.commit-files.outputs.has_changes == 'true'
      run: |
        git push
